name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-code-review:
    # Only run on pull requests or when comment contains trigger phrase
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.event.issue.pull_request.head.sha }}

      - name: Get PR diff
        id: pr-diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            # For issue comments, fetch PR info
            PR_NUMBER="${{ github.event.issue.number }}"
            BASE_SHA=$(gh pr view $PR_NUMBER --json baseRefOid -q .baseRefOid)
          fi
          
          # Get the diff and escape it for JSON
          DIFF=$(git diff $BASE_SHA...HEAD | head -c 50000)
          
          # Save diff to file for Claude
          echo "$DIFF" > pr-diff.txt
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read project context
        id: context
        run: |
          # Read CLAUDE.md for project context
          if [ -f "CLAUDE.md" ]; then
            CONTEXT=$(cat CLAUDE.md | head -c 10000)
            echo "context<<EOF" >> $GITHUB_OUTPUT
            echo "$CONTEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Claude Code Review
        id: claude-review
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const https = require('https');
            
            // Read the diff file
            const fs = require('fs');
            const diff = fs.readFileSync('pr-diff.txt', 'utf8');
            
            const prNumber = context.issue.number || context.payload.pull_request.number;
            const prTitle = context.payload.pull_request?.title || 'PR';
            const prBody = context.payload.pull_request?.body || '';
            const projectContext = process.env.CONTEXT || '';
            
            // Prepare prompt for Claude
            const prompt = 'You are a senior software engineer performing a code review for the following pull request:\n\n' +
              'PR Title: ' + prTitle + '\n' +
              'PR Description: ' + prBody + '\n\n' +
              'Project Context (from CLAUDE.md):\n' + projectContext + '\n\n' +
              'Code Changes:\n```diff\n' + diff + '\n```\n\n' +
              'Please review this code and provide:\n' +
              '1. Security concerns (especially OWASP vulnerabilities)\n' +
              '2. Code quality issues\n' +
              '3. Best practice violations\n' +
              '4. Suggestions for improvement\n' +
              '5. Positive feedback for good practices\n\n' +
              'Focus on actionable feedback. Be constructive and specific.';

            // Call Claude API
            const data = JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 4096,
              messages: [{
                role: 'user',
                content: prompt
              }]
            });

            const options = {
              hostname: 'api.anthropic.com',
              port: 443,
              path: '/v1/messages',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01',
                'Content-Length': data.length
              }
            };

            return new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => { body += chunk; });
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    const response = JSON.parse(body);
                    const review = response.content[0].text;
                    
                    // Post review as comment
                    github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      body: `## ü§ñ Claude Code Review\n\n${review}\n\n---\n*Automated review by Claude Code*`
                    });
                    
                    resolve(review);
                  } else {
                    reject(new Error(`Claude API returned ${res.statusCode}: ${body}`));
                  }
                });
              });

              req.on('error', (e) => reject(e));
              req.write(data);
              req.end();
            });

      - name: Handle errors
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number || context.payload.pull_request.number;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ‚ö†Ô∏è Claude Code Review Failed\n\nThe automated code review encountered an error. Please check:\n1. The ANTHROPIC_API_KEY secret is configured\n2. The API key has sufficient credits\n3. The workflow logs for detailed error messages\n\n*You can manually trigger the review by commenting \`@claude\` on this PR.*`
            });
